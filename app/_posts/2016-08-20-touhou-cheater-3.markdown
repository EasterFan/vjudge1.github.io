---
layout: post
title: "自己动手写東方Project作弊器（三）（未完待续）"
author: vjudge1
categories: 游戏
tags: 東方Project 反汇编
---
* contents
{:toc}

東方Project还有若干格斗游戏，主要由黄昏边境开发。作为有官方设定的歪作，当然也应该通通关。

虽然黄昏的画风不错，可是，这样一个全是萝莉的格斗游戏居然没有格斗游戏应有的功能<span class="blackout">例如乳摇和爆乳</span>（没法和[DOA](http://cn.uncyclopedia.wikia.com/wiki/DOA)相比），更过分的是，双方根本就是**8比特的马赛克小人**！所以说，给东方的格斗游戏写个作弊器/修改器也是理所应当的了（坏笑）。

作弊作到什么程度呢？速推——自己不死，对方一击毙命。




{% callout %}
#### 未完待续

东方的游戏多到[连吉尼斯都有纪录的程度](https://web.archive.org/web/20130424041751/http://www.guinnessworldrecords.com/records-8000/most-prolific-fan-made-shooter-series/)了，而且格斗类游戏似乎搜不到现成的作弊码……我只能慢慢更新了Orz。
{% endcallout %}

# 萃梦想
（版本：1.11）

研究萃梦想的作弊（说好听点叫修改），首先得去打游戏。我个人打不好东方的格斗游戏，怎么办呢？经过试验，发现剧情模式和双人模式的地址都是一样的（废话），所以直接开双人就行。

人数地址是固定的，在剧情模式里挨几顿打就能搜出来了（671622）。写这个地址的指令位于43CD5D，改写成三个90，就不会GAME OVER了。

血槽地址是动态的，每打一架都会变化，而且双方都变，所以搜索要一气呵成（使用模糊搜索，大概需要搜八九次）。满血是10000。搜到地址之后马上定位，可以找到三个地址：44365C（自己和对手掉血，血的偏移量是324，短的那部分——我不懂格斗类游戏的术语，别笑话我）、4436EB（自己和对手掉<del>血</del>应该是体力吧，长的那部分，数据地址偏移量是326）、4425FE（自己的，和血量同步，数据地址偏移量328）。

{% callout %}
#### 补充

能够改变血量的地址还有443E19（偏移量324）、444BD5（偏移量324，发动符卡之后）、444C0D（偏移量328，发动符卡之后）、444D16（偏移量328，发动符卡之后）等。精力有限所以没挨个研究具体作用。
{% endcallout %}

值得注意的是，自己和对手掉血的指令是同一个指令，因此不能直接NOP或者直接MOV成0。为了省事儿，先把4436EB、4425FE和443E19给NOP掉（均改为7个90），专门研究血量。

注意443657处的SUB，将其改为`2B C9`（`sub ecx, ecx`，直接归零）后，对方就可以被一拳头打趴下了。但是，自己也会被对方一拳打趴下。因此还要设法分清敌我。

![]({{ site.baseurl }}/img/2016-08-20-touhou-3/th75.png)

为了接下来的调试，443657还得改回来。在此处下断点，发现只有EAX寄存器的值有区别（ECX、EDX分别是血量和血量变化，不用管）。EAX取自`[ebp+10]`，而双方挨打时EBP均为19FA04。

一开始我的思路是关注堆栈的变化情况，虽然找得很辛苦，但是没有任何成效。

后来重新思考一下——既然有`mov eax, [ebp+10]`，还有一个`[eax+324]`，那么这不就是个指针吗？因此，换用游戏修改器，搜索一下指针所指的内存地址（当然两个角色的`[ebp+10]`的值得记下来，然后马上搜，要不然只要重新开一盘内容就变了），于是发现了指针本身所处地址——1P是671418，2P是67141C。

现在的问题就变成了：如何在扣血之前将双方的地址分辨出来，分别处理（与671418相同时不处理，与67141C相同时直接打死）？或者一不做二不休直接把对方打死？

后者比较简单，先尝试一下，不过修改完发现有个bug就是对方打自己之后双方就无法继续打下去了，因此还得选择前者。

从44365C往前改，重新编一段新代码，内容大致是（受影响的部分可以直接换掉，或者NOP掉）：

```nasm
...
443642: mov ecx, dword ptr [ebp+0C]
        ; 以下是新代码（nop已省略）
        mov ecx, [ebp+10]
        cmp ecx, [671418]
        je 443663
        sub ecx, ecx
        mov edx, [67141C]
        ; 以上是新代码
44365C: mov word ptr [edx+324], cx
...
```

上面代码的最后一行`mov word ptr ...`是游戏原始的代码，无需更改。

换成机器码，发现从443645（`call 00455640`，计算掉血量的，可以扔掉）开始均受到了波及，于是就从443645开始，改成

```
90 90 90 90
8B 4D 10
3B 0D 18 14 67 00
74 0F
29 C9
8B 15 1C 14 67 00
... ;EDX+324那行不变
```

实际上，在对手发动符卡的时候，这段指令并不起作用（如果想在符卡里面一击毙命，可以把444BD0改成`2B D2`，记得后果自负）。但只要保证自己能有机会伸手，就已经差不多可以随便欺负小女生了。

# 绯想天（未完待续）

# 非想天则（未完待续）

# 心绮楼（未完待续）

# 深秘录（未完待续）

# 参考资料

这次都是<del>自找</del>自己研究的，只有运气，没有现成资料。
